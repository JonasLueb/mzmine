name: AI Issue Intake

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to assess
        required: true
        type: number

permissions:
  issues: write
  contents: read
  models: read

jobs:
  ai_intake:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.issue.labels.*.name, 'request ai review')
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}
      ISSUE_BODY: ${{ github.event_name == 'workflow_dispatch' && '' || github.event.issue.body }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Ensure labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ['request ai review', 'type:bug', 'bug', 'question', 'installation'];
            for (const name of labels) {
              try {
                await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name });
              } catch (e) {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, name, color: 'ededed' });
              }
            }

      - name: Fetch issue body (dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt(process.env.ISSUE_NUMBER, 10);
            const { data: issue } = await github.rest.issues.get({ owner: context.repo.owner, repo: context.repo.repo, issue_number });
            core.exportVariable('ISSUE_BODY', issue.body || '');

      - name: Run AI assessment and labeler
        uses: github/ai-assessment-comment-labeler@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue_number: ${{ env.ISSUE_NUMBER }}
          issue_body: ${{ env.ISSUE_BODY }}
          owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
          ai_review_label: request ai review
          prompts_directory: ./Prompts
          labels_to_prompts_mapping: "type:bug,bug-review.prompt.yml|bug,bug-review.prompt.yml|question,usage-check.prompt.yml|installation,env-triage.prompt.yml|request ai review,intake.prompt.yml"

      - name: Remove trigger label to allow re-run on re-add
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;
            const label = 'request ai review';
            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name: label });
            } catch (e) {
              // ignore if already removed
            }
